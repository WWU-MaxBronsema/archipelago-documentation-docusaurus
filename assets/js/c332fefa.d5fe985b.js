"use strict";(self.webpackChunkarchipelago_documentation_docsaurus=self.webpackChunkarchipelago_documentation_docsaurus||[]).push([[4738],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>h});var o=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var i=o.createContext({}),p=function(e){var t=o.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},c=function(e){var t=p(e.components);return o.createElement(i.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(a),m=n,h=d["".concat(i,".").concat(m)]||d[m]||u[m]||r;return a?o.createElement(h,l(l({ref:t},c),{},{components:a})):o.createElement(h,l({ref:t},c))}));function h(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,l=new Array(r);l[0]=m;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s[d]="string"==typeof e?e:n,l[1]=s;for(var p=2;p<r;p++)l[p]=a[p];return o.createElement.apply(null,l)}return o.createElement.apply(null,a)}m.displayName="MDXCreateElement"},72:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var o=a(7462),n=(a(7294),a(3905));const r={title:"Archipelago-deployment-live: upgrading to 1.0.0 (1.0.0-RC3 to 1.0.0)",tags:["Archipelago-deployment-live","Drupal 9"]},l="Archipelago-deployment-live: upgrading from 1.0.0-RC3 to 1.0.0",s={unversionedId:"archipelago-deployment-live-upgradeFromRC3",id:"archipelago-deployment-live-upgradeFromRC3",title:"Archipelago-deployment-live: upgrading to 1.0.0 (1.0.0-RC3 to 1.0.0)",description:"What is this documentation for?",source:"@site/docs/archipelago-deployment-live-upgradeFromRC3.md",sourceDirName:".",slug:"/archipelago-deployment-live-upgradeFromRC3",permalink:"/archipelago-documentation-docusaurus/docs/archipelago-deployment-live-upgradeFromRC3",draft:!1,editUrl:"https://pr.new/github.com/WWU-MaxBronsema/archipelago-documentation-docusaurus/docs/archipelago-deployment-live-upgradeFromRC3.md",tags:[{label:"Archipelago-deployment-live",permalink:"/archipelago-documentation-docusaurus/docs/tags/archipelago-deployment-live"},{label:"Drupal 9",permalink:"/archipelago-documentation-docusaurus/docs/tags/drupal-9"}],version:"current",frontMatter:{title:"Archipelago-deployment-live: upgrading to 1.0.0 (1.0.0-RC3 to 1.0.0)",tags:["Archipelago-deployment-live","Drupal 9"]},sidebar:"tutorialSidebar",previous:{title:"Archipelago-deployment-live: upgrading Drupal 8 to Drupal 9 (1.0.0-RC2 to 1.0.0-RC3)",permalink:"/archipelago-documentation-docusaurus/docs/archipelago-deployment-live-upgradeFromD8ToD9"},next:{title:"Installing Archipelago Drupal 9 on OSX (macOS)",permalink:"/archipelago-documentation-docusaurus/docs/archipelago-deployment-osx"}},i={},p=[{value:"What is this documentation for?",id:"what-is-this-documentation-for",level:2},{value:"Requirements",id:"requirements",level:2},{value:"Backing up and preparing for the upgrade",id:"backing-up-and-preparing-for-the-upgrade",level:2},{value:"Step 1:",id:"step-1",level:3},{value:"Step 2:",id:"step-2",level:3},{value:"Step 3:",id:"step-3",level:3},{value:"Step 4:",id:"step-4",level:3},{value:"Step 5:",id:"step-5",level:3},{value:"Upgrading to 1.0.0",id:"upgrading-to-100",level:2},{value:"Step 1:",id:"step-1-1",level:3},{value:"Step 2:",id:"step-2-1",level:3},{value:"Step 3:",id:"step-3-1",level:3},{value:"What if not all is OK and I see red and a lot of dependency explanations?",id:"what-if-not-all-is-ok-and-i-see-red-and-a-lot-of-dependency-explanations",level:4},{value:"Step 4:",id:"step-4-1",level:3},{value:"Step 5:",id:"step-5-1",level:3},{value:"A Partial Sync, which will bring new configs and update existing ones but will <strong>not</strong> remove ones that only exist in your custom setup, e.g. new Webforms or View Modes.",id:"a-partial-sync-which-will-bring-new-configs-and-update-existing-ones-but-will-not-remove-ones-that-only-exist-in-your-custom-setup-eg-new-webforms-or-view-modes",level:4},{value:"A Complete Sync, which will bring new configs and update existing ones but will also remove all the ones that are not part of RC3. It&#39;s a like clean factory reset.",id:"a-complete-sync-which-will-bring-new-configs-and-update-existing-ones-but-will-also-remove-all-the-ones-that-are-not-part-of-rc3-its-a-like-clean-factory-reset",level:4},{value:"Step 7: Update (or not) your Metadata Display Entities and Menu items.",id:"step-7-update-or-not-your-metadata-display-entities-and-menu-items",level:3}],c={toc:p},d="wrapper";function u(e){let{components:t,...a}=e;return(0,n.kt)(d,(0,o.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"archipelago-deployment-live-upgrading-from-100-rc3-to-100"},"Archipelago-deployment-live: upgrading from 1.0.0-RC3 to 1.0.0"),(0,n.kt)("h2",{id:"what-is-this-documentation-for"},"What is this documentation for?"),(0,n.kt)("p",null,"If you already have a well-set-up and well-loved Archipelago (RC3 or your own custom version) running Drupal 9, this documentation will allow you to update to 1.0.0 without major issues."),(0,n.kt)("h2",{id:"requirements"},"Requirements"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"An ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/esmero/archipelago-deployment-live"},"archipelago-deployment-live")," instance 1.0.0-RC3 (working, tested) deployed using provided instructions via Docker and running Drupal 9."),(0,n.kt)("li",{parentName:"ul"},"Basic knowledge and instincts (+ courage) on how to run Terminal Commands, ",(0,n.kt)("inlineCode",{parentName:"li"},"composer")," and ",(0,n.kt)("inlineCode",{parentName:"li"},"drush"),"."),(0,n.kt)("li",{parentName:"ul"},"Patience. You can't skip steps here."),(0,n.kt)("li",{parentName:"ul"},"For Shell Commands documented here please copy line by line\u2014not the whole block.")),(0,n.kt)("h2",{id:"backing-up-and-preparing-for-the-upgrade"},"Backing up and preparing for the upgrade"),(0,n.kt)("p",null,"Backups are always going to be your best friends. Archipelago's code, database and settings are mostly self-contained in your current ",(0,n.kt)("inlineCode",{parentName:"p"},"archipelago-deployment-live")," repo folder, and backing up is simple because of that."),(0,n.kt)("h3",{id:"step-1"},"Step 1:"),(0,n.kt)("p",null,"Shut down your ",(0,n.kt)("inlineCode",{parentName:"p"},"docker-compose")," ensemble. Move to your ",(0,n.kt)("inlineCode",{parentName:"p"},"archipelago-deployment-live")," folder and run this:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"cd deploy/ec2-docker\ndocker-compose down\n")),(0,n.kt)("h3",{id:"step-2"},"Step 2:"),(0,n.kt)("p",null,"Verify that all containers are actually down. The following command should return an empty listing. If anything is still running, wait a little longer, and run the following comman again."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker ps\n")),(0,n.kt)("h3",{id:"step-3"},"Step 3:"),(0,n.kt)("p",null,"Now let's ",(0,n.kt)("inlineCode",{parentName:"p"},"tar.gz")," the whole ensemble with data and configs. As an example we will save this into your ",(0,n.kt)("inlineCode",{parentName:"p"},"$HOME")," folder.\nAs a good practice we append the ",(0,n.kt)("strong",{parentName:"p"},"current date "),"(YEAR-MONTH-DAY) to the filename. Here we assume today is December 1st of 2021."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"sudo tar -czvpf $HOME/archipelago-deployment-live-backup-20220803.tar.gz ../../../archipelago-deployment-live\n")),(0,n.kt)("p",null,"The process may take a few minutes. Now let's verify that all is there and that the ",(0,n.kt)("inlineCode",{parentName:"p"},"tar.gz")," is not corrupt."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"tar -tvvf $HOME/archipelago-deployment-live-backup-20220803.tar.gz \n")),(0,n.kt)("p",null,"You will see a listing of files. If corrupt (Do you have enough space? Did your ssh connection drop?) you will see the following:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"tar: Unrecognized archive format\n")),(0,n.kt)("h3",{id:"step-4"},"Step 4:"),(0,n.kt)("p",null,"Restart your ",(0,n.kt)("inlineCode",{parentName:"p"},"docker-compose")," ensemble, and wait a little while for all to start."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker-compose up -d\n")),(0,n.kt)("h3",{id:"step-5"},"Step 5:"),(0,n.kt)("p",null,"Export/backup all of your live Archipelago configurations (this allows you to compare/come back in case you lose something custom during the upgrade)."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec esmero-php mkdir config/backup\ndocker exec esmero-php drush cex --destination=/var/www/html/config/backup\n")),(0,n.kt)("p",null,"Good. Now it's safe to begin the upgrade."),(0,n.kt)("hr",null),(0,n.kt)("h2",{id:"upgrading-to-100"},"Upgrading to 1.0.0"),(0,n.kt)("h3",{id:"step-1-1"},"Step 1:"),(0,n.kt)("p",null,"First we are going to disable modules that are not part of 1.0.0 or are not yet compatible with Drupal 9.4.x or higher . Run the following command:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec esmero-php drush pm-uninstall search_api_solr_defaults entity_reference\n")),(0,n.kt)("p",null,"From inside your ",(0,n.kt)("inlineCode",{parentName:"p"},"archipelago-deployment-live")," repo folder we are going to open up the file ",(0,n.kt)("inlineCode",{parentName:"p"},"permissions")," for some of your most protected Drupal files."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"cd ../../\nsudo chmod 777 drupal/web/sites/default\nsudo chmod 666 drupal/web/sites/default/*settings.php\nsudo chmod 666 drupal/web/sites/default/*services.yml\n")),(0,n.kt)("h3",{id:"step-2-1"},"Step 2:"),(0,n.kt)("p",null,"First let's back up our current composer.lock:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"cp drupal/composer.lock drupal/composer.original.lock\n")),(0,n.kt)("p",null,"Time to fetch the ",(0,n.kt)("inlineCode",{parentName:"p"},"1.0.0")," branch and update our ",(0,n.kt)("inlineCode",{parentName:"p"},"docker-compose")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"composer")," dependencies. We are also going to stop the current ",(0,n.kt)("inlineCode",{parentName:"p"},"docker")," ensemble to update all containers to newer versions:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"cd deploy/ec2-docker\ndocker-compose down\ngit fetch\ngit checkout 1.0.0 \n")),(0,n.kt)("p",null,"If you decide to enable the Drupal REDIS module, make sure to add the ",(0,n.kt)("inlineCode",{parentName:"p"},"REDIS_PASSWORD")," variable to your ",(0,n.kt)("inlineCode",{parentName:"p"},".env")," file."),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"IMPORTANT NOTE"),": For AWS EC2. If you selected an ",(0,n.kt)("inlineCode",{parentName:"p"},"IAM role")," for your server when setting it up/deploying it, ",(0,n.kt)("inlineCode",{parentName:"p"},"min.io")," will use the AWS EC2-backed internal API to request access to your S3. This means the ROLE itself needs to have read/write access (ACL) to the given Bucket(s) and your key/secrets won't be able to override that. Please do not ignore this note. It will save you a LOT of frustration and coffee. You can also run an EC2 instance without a given IAM and in that case just the ACCESS_KEY/SECRET will matter."),(0,n.kt)("p",null,"Now that you know, you also know that these values ",(0,n.kt)("strong",{parentName:"p"},"should not be shared")," and this ",(0,n.kt)("inlineCode",{parentName:"p"},".env")," file ",(0,n.kt)("strong",{parentName:"p"},"should not be committed/kept in version control"),". Please be careful."),(0,n.kt)("p",null,"Now let's back up the existing ",(0,n.kt)("inlineCode",{parentName:"p"},"docker-compose")," file:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"cp docker-compose.yml docker-compose-original.yml\n")),(0,n.kt)("p",null,"Then copy the appropriate ",(0,n.kt)("inlineCode",{parentName:"p"},"docker-compose")," file for your architecture:"),(0,n.kt)("p",null,'??? info "Linux/x86-64/AMD64"'),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"```shell\ncp docker-compose-aws-s3.yml docker-compose.yml\n```\n")),(0,n.kt)("p",null,'??? info "Linux/ARM64/Apple Silicon (M1 and M2)"'),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"```shell\ncp docker-compose-aws-s3-arm64.yml docker-compose.yml\n```\n")),(0,n.kt)("p",null,"Next, let's review what's changed in case any customizations need to be brought into the new ",(0,n.kt)("inlineCode",{parentName:"p"},"docker-compose")," configurations:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"git diff --no-index docker-compose-original.yml docker-compose.yml\n")),(0,n.kt)("p",null,"You should encounter something like the following:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-diff"},'diff --git a/docker-compose-original.yml b/docker-compose.yml\nindex 6f5b17e..282417f 100644\n--- a/docker-compose-original.yml\n+++ b/docker-compose.yml\n@@ -1,5 +1,5 @@\n # Run docker-compose up -d\n-\n+# Docker file for AMD64/X86 machines\n version: \'3.5\'\n services:\n   web:\n@@ -23,6 +23,7 @@ services:\n       - solr\n       - php\n       - db\n+      - redis\n     tty: true\n     networks:\n       - host-net\n@@ -30,7 +31,7 @@ services:\n   php:\n     container_name: esmero-php\n     restart: always\n-    image: "esmero/php-7.4-fpm:1.0.0-RC2-multiarch"\n+    image: "esmero/php-8.0-fpm:1.1.0-multiarch"\n     tty: true\n     networks:\n       - host-net\n@@ -44,10 +45,11 @@ services:\n       MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}\n       MINIO_BUCKET_MEDIA: ${MINIO_BUCKET_MEDIA}\n       MINIO_FOLDER_PREFIX_MEDIA: ${MINIO_FOLDER_PREFIX_MEDIA}\n+      REDIS_PASSWORD: ${REDIS_PASSWORD}\n   solr:\n     container_name: esmero-solr\n     restart: always\n-    image: "solr:8.8.2"\n+    image: "solr:8.11.2"\n')),(0,n.kt)("p",null,"As you can see, most of the changes in this example are for new images and a new service/container/environment variable (REDIS), but you may have custom settings for your containers. Review any differences carefully and make adjustments as needed."),(0,n.kt)("p",null,"Finally, pull the images:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker compose pull \n")),(0,n.kt)("p",null,"1.0.0 provides a new Cantaloupe that uses different permissions so we need to adapt those. From your current folder (../ec2-deploy) run:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"sudo chown 8183:8183 ../../config_storage/iiifconfig/cantaloupe.properties\nsudo chown -R 8183:8183 ../../data_storage/iiifcache\nsudo chown -R 8183:8183 ../../data_storage/iiiftmp\n")),(0,n.kt)("p",null,"Time to start the ensemble again"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker compose up -d\n")),(0,n.kt)("p",null,"Give all a little time to start. ",(0,n.kt)("inlineCode",{parentName:"p"},"Solr")," core and ",(0,n.kt)("inlineCode",{parentName:"p"},"Database")," need to be upgraded, Cantaloupe is new and this brings also Redis for caching. Please be patient. To ensure all is well, run (more than once if necessary) the following:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker ps\n")),(0,n.kt)("p",null,"You should see something like this:\ne.g if running on ARM64 You should see something like this: "),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'CONTAINER ID   IMAGE                                    COMMAND                  CREATED          STATUS          PORTS                                                           NAMES\n4ed2f62e866e   jonasal/nginx-certbot                      "/docker-entrypoint.\u2026" 32 seconds ago   Up 27 seconds   0.0.0.0:80->80/tcp, :::80->80/tcp, 0.0.0.0:443->443/tcp, :::443->443/tcp   esmero-web\ne6b4383039c3   minio/minio:RELEASE.2022-06-11T19-55-32Z   "/usr/bin/docker-ent\u2026" 33 seconds ago   Up 30 seconds   0.0.0.0:9000-9001->9000-9001/tcp, :::9000-9001->9000-9001/tcp              esmero-minio\nf2b6b173b7e2   solr:8.11.2                                "docker-entrypoint.s\u2026" 33 seconds ago   Up 28 seconds   0.0.0.0:8983->8983/tcp, :::8983->8983/tcp                                  esmero-solr\na553bf484343   esmero/php-8.0-fpm:1.0.0-multiarch         "docker-php-entrypoi\u2026" 33 seconds ago   Up 30 seconds   9000/tcp                                                                   esmero-php\necb47349ae94   esmero/esmero-nlp:fasttext-multiarch       "/usr/local/bin/entr\u2026" 33 seconds ago   Up 30 second    0.0.0.0:6400->6400/tcp, :::6400->6400/tcp                                  esmero-nlp\n61272dce034a   redis:6.2-alpine                           "docker-entrypoint.s\u2026" 33 seconds ago   Up 28 seconds                                                                              esmero-redis\n0ee9869f809b   esmero/cantaloupe-s3:6.0.0-multiarch       "sh -c \'java -Dcanta\u2026" 33 seconds ago   Up 28 seconds   0.0.0.0:8183->8182/tcp, :::8183->8182/tcp                                  esmero-cantaloupe\n131d072567ce   mariadb:10.6.8-focal                       "docker-entrypoint.s\u2026" 33 seconds ago   Up 28 seconds   3306/tcp                                                                   esmero-db                                            esmero-php\n')),(0,n.kt)("p",null,"Important here is the ",(0,n.kt)("inlineCode",{parentName:"p"},"STATUS")," column. It ",(0,n.kt)("strong",{parentName:"p"},"needs")," to be a number that goes up in time every time you run ",(0,n.kt)("inlineCode",{parentName:"p"},"docker ps")," again (and again)."),(0,n.kt)("h3",{id:"step-3-1"},"Step 3:"),(0,n.kt)("p",null,"Instead of using the provided ",(0,n.kt)("inlineCode",{parentName:"p"},"composer.default.lock")," out of the box we are going to loosen certain dependencies and bring manually Archipelago modules, all this to make update easier and future upgrades less of a pain."),(0,n.kt)("p",null,"First, as a sanity check let's make sure nothing happened to our original ",(0,n.kt)("inlineCode",{parentName:"p"},"composer.lock")," fileby doing a diff against our backed up file:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"git diff --no-index ../../drupal/composer.original.lock ../../drupal/composer.lock\n")),(0,n.kt)("p",null,"If all is ok, there should be no output. If there's any output, copy your backed up file back to default:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"cp ../../drupal/composer.original.lock ../../drupal/composer.lock\n")),(0,n.kt)("p",null,"Finally, we bring over the modules:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'docker exec -ti esmero-php bash -c "composer require drupal/core:^9 drupal/core-composer-scaffold:^9 drupal/core-project-message:^9 drupal/core-recommended:^9"\ndocker exec -ti esmero-php bash -c "composer require drupal/core-dev:^9 --dev"\ndocker exec -ti esmero-php bash -c "composer require drupal/tokenuuid:^2"\ndocker exec -ti esmero-php bash -c "composer require \'drupal/facets:^2.0\'"\ndocker exec -ti esmero-php bash -c "composer require drupal/moderated_content_bulk_publish:^2"\ndocker exec -ti esmero-php bash -c "composer require drupal/queue_ui:^3.1"\ndocker exec -ti esmero-php bash -c "composer require archipelago/ami:0.4.0.x-dev strawberryfield/format_strawberryfield:1.0.0.x-dev strawberryfield/strawberryfield:1.0.0.x-dev strawberryfield/strawberry_runners:0.4.0.x-dev strawberryfield/webform_strawberryfield:1.0.0.x-dev drupal/views_bulk_operations:^4.1"\n')),(0,n.kt)("p",null,"Now we are going to tell ",(0,n.kt)("inlineCode",{parentName:"p"},"composer")," to actually fetch the new code and dependencies using ",(0,n.kt)("inlineCode",{parentName:"p"},"composer.lock")," and update the whole Drupal/PHP/JS environment."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'docker exec -ti esmero-php bash -c "composer update -W"\ndocker exec -ti esmero-php bash -c "drush cr"\ndocker exec -ti esmero-php bash -c "drush en jquery_ui_touch_punch"\ndocker exec -ti esmero-php bash -c "drush updatedb"\n')),(0,n.kt)("p",null,"Well done! If you see ",(0,n.kt)("strong",{parentName:"p"},"no")," issues and all ends in a ",(0,n.kt)("strong",{parentName:"p"},"Green colored message")," all is good! ",(0,n.kt)("a",{parentName:"p",href:"#step-4_1"},"Jump to Step 4")),(0,n.kt)("h4",{id:"what-if-not-all-is-ok-and-i-see-red-and-a-lot-of-dependency-explanations"},"What if not all is OK and I see red and a lot of dependency explanations?"),(0,n.kt)("p",null,"If you have manually installed packages via composer in the past that are NO longer Drupal 9 compatible you may see errors.\nIn that case you need to check each package website's (normally ",(0,n.kt)("a",{parentName:"p",href:"https://www.drupal.org/project/the_module_name"},"https://www.drupal.org/project/the_module_name"),") and check if there is a Drupal 9 compatible version. "),(0,n.kt)("p",null,"If so run:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec -ti esmero-php bash -c \"composer require 'drupal/the_module_name:^VERSION_NUMBER_THAT_WORKS_ON_DRUPAL9_' --update-with-dependencies --no-update\" and run **Step 3 ** again (and again until all is cleared)\n")),(0,n.kt)("p",null,"If not: try to find a replacement module that does something simular, but in any case you may end having to remove before proceding. Give us a ping/slack/google group/open a github ISSUE if you find yourself uncertain about this. "),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'docker exec -ti esmero-php bash -c "composer remove drupal/the_module_name --no-update"\ndocker exec -ti esmero-php bash -c " drush pm-uninstall the_module_name"\n')),(0,n.kt)("h3",{id:"step-4-1"},"Step 4:"),(0,n.kt)("p",null,"We will now ask Drupal to update some internal configs and databases. They will bring you up to date with 1.0.0 settings and D9 particularities."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec -ti esmero-php bash -c 'scripts/archipelago/setup.sh'\ndocker exec -ti esmero-php bash -c \"drush updatedb\"\n")),(0,n.kt)("h3",{id:"step-5-1"},"Step 5:"),(0,n.kt)("p",null,"Now you can Sync your new Archipelago 1.0.0 and bring all the new configs and settings in. For this you have ",(0,n.kt)("strong",{parentName:"p"},"two")," options (no worries, remember you made a backup!):"),(0,n.kt)("h4",{id:"a-partial-sync-which-will-bring-new-configs-and-update-existing-ones-but-will-not-remove-ones-that-only-exist-in-your-custom-setup-eg-new-webforms-or-view-modes"},"A Partial Sync, which will bring new configs and update existing ones but will ",(0,n.kt)("strong",{parentName:"h4"},"not")," remove ones that only exist in your custom setup, e.g. new Webforms or View Modes."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec esmero-php drush cim -y --partial\n")),(0,n.kt)("h4",{id:"a-complete-sync-which-will-bring-new-configs-and-update-existing-ones-but-will-also-remove-all-the-ones-that-are-not-part-of-rc3-its-a-like-clean-factory-reset"},"A Complete Sync, which will bring new configs and update existing ones but will also remove all the ones that are not part of RC3. It's a like clean factory reset."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec esmero-php drush cim -y\n")),(0,n.kt)("p",null,"If all goes well here and you see no errors it's time to reindex ",(0,n.kt)("inlineCode",{parentName:"p"},"Solr")," because there are new Fields. Run the following:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec esmero-php drush search-api-reindex\ndocker exec esmero-php drush search-api-index\n")),(0,n.kt)("p",null,"You might see some warnings related to modules dealing with previously non-existent data\u2014no worries, just ignore those."),(0,n.kt)("p",null,"If you made it this far you are done with code/devops (are we ever ready?), and that means you should be able to (hopefully) stay in the Drupal 9 realm for a few years!"),(0,n.kt)("h3",{id:"step-7-update-or-not-your-metadata-display-entities-and-menu-items"},"Step 7: Update (or not) your Metadata Display Entities and Menu items."),(0,n.kt)("p",null,"Recommended: If you want to add new templates and menu items 1.0.0 provides, go to your base Github repo folder, replace in the following commands ",(0,n.kt)("inlineCode",{parentName:"p"},"your.domain.org")," with the actual domain of your Server and run those individually:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"sed -i 's/http:\\/\\/esmero-web/https:\\/\\/your.domain.org/g' drupal/scripts/archipelago/deploy.sh\n")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"sed -i 's/http:\\/\\/esmero-web/https:\\/\\/your.domain.org/g' drupal/scripts/archipelago/update_deployed.sh\n")),(0,n.kt)("p",null,"Now update your Metadata Display Templates and Blocks"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec -ti esmero-php bash -c 'scripts/archipelago/deploy.sh'\n")),(0,n.kt)("p",null,"Once that is done, you can choose to update all Metadata Displays (Twig templates) we ship with new 1.0.0 versions (heavily fixed IIIF manifest, Markdown to HTML for Metadata, better Object descriptions). But before you do this, we ",(0,n.kt)("strong",{parentName:"p"},"really")," recommend that you first make sure to manually (copy/paste) backup any Twig templates you have modified. If unusure, do not run the command that comes after this warning! You can always manually copy the new templates from the ",(0,n.kt)("inlineCode",{parentName:"p"},"d8content/metadatadisplays")," folder which contains text versions (again, copy/paste) of each shipped template you can pick and use when you feel ready."),(0,n.kt)("p",null,"If you are sure (like really?) you want to overwrite the ones you modified (sure, just checking?), then you can run this:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec -ti esmero-php bash -c 'scripts/archipelago/update_deployed.sh'\n")),(0,n.kt)("p",null,"Done! (For realz now)"),(0,n.kt)("p",null,"Please log into your Archipelago and test/check all is working! Enjoy 1.0.0. Thanks!"),(0,n.kt)("hr",null),(0,n.kt)("p",null,"Thank you for reading! Please contact us on our ",(0,n.kt)("a",{parentName:"p",href:"https://groups.google.com/forum/#!forum/archipelago-commons"},"Archipelago Commons Google Group")," with any questions or feedback, or open an ISSUE in this ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/esmero/archipelago-deployment-live/"},"Archipelago Deployment Live Repository"),"."),(0,n.kt)("p",null,"Return to ",(0,n.kt)("a",{parentName:"p",href:"/archipelago-documentation-docusaurus/docs/archipelago-deployment-live-readme"},"Archipelago Live Deployment"),"."))}u.isMDXComponent=!0}}]);