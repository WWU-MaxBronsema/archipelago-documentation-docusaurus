"use strict";(self.webpackChunkarchipelago_documentation_docsaurus=self.webpackChunkarchipelago_documentation_docsaurus||[]).push([[5094],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=p(n),m=o,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||a;return n?r.createElement(h,s(s({ref:t},c),{},{components:n})):r.createElement(h,s({ref:t},c))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,s=new Array(a);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[u]="string"==typeof e?e:o,s[1]=i;for(var p=2;p<a;p++)s[p]=n[p];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},8685:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>i,toc:()=>p});var r=n(7462),o=(n(7294),n(3905));const a={},s="How to Setup SSL for Docker/Archipelago",i={unversionedId:"sslsetup",id:"sslsetup",title:"How to Setup SSL for Docker/Archipelago",description:"*Work-In-Progress Note* This documentation page is still under construction and content may change with future updates. Please use caution when implementing any instructions referenced herein, as there may be missing steps or corresponding configuration files. Thank you for your patience as we continue to update Archipelago's documentation.",source:"@site/docs/sslsetup.md",sourceDirName:".",slug:"/sslsetup",permalink:"/archipelago-documentation-docusaurus/docs/sslsetup",draft:!1,editUrl:"https://pr.new/github.com/WWU-MaxBronsema/archipelago-documentation-docusaurus/docs/sslsetup.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Archipelago Presentations and Documents",permalink:"/archipelago-documentation-docusaurus/docs/presentations_docs"},next:{title:"Strawberryfield Formatters",permalink:"/archipelago-documentation-docusaurus/docs/strawberryfield-formatters"}},l={},p=[{value:"Manual Configuration Steps for an EC2 AWS Server",id:"manual-configuration-steps-for-an-ec2-aws-server",level:3},{value:"User contributed documentation:",id:"user-contributed-documentation",level:3}],c={toc:p},u="wrapper";function d(e){let{components:t,...n}=e;return(0,o.kt)(u,(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"how-to-setup-ssl-for-dockerarchipelago"},"How to Setup SSL for Docker/Archipelago"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},(0,o.kt)("em",{parentName:"em"},"Work-In-Progress Note")," This documentation page is still under construction and content may change with future updates. Please use caution when implementing any instructions referenced herein, as there may be missing steps or corresponding configuration files. Thank you for your patience as we continue to update Archipelago's documentation.")),(0,o.kt)("p",null,"The steps found below describe one potential manual SSL configuration for Archipelago deployments. A ",(0,o.kt)("inlineCode",{parentName:"p"},"git clone")," deployment option will be available for future releases."),(0,o.kt)("h3",{id:"manual-configuration-steps-for-an-ec2-aws-server"},"Manual Configuration Steps for an EC2 AWS Server"),(0,o.kt)("p",null,"This process takes less than 10 minutes of reading YML files and editing a few files (described below) to get SSL running and setup with auto-renewal."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"First, configure Certbot, following the instructions found on ",(0,o.kt)("a",{parentName:"p",href:"https://certbot.eff.org"},"https://certbot.eff.org"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Inside a /persistent partition, establish the following folder structure.\n",(0,o.kt)("em",{parentName:"p"},"Note: you can keep the existing folder structure if you so choose. A benefit of the following structure is that it decouples the git clone of archipelago-deployment, which is made to be self sustainable and good for coding or smaller deployments.")),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"```Shell\n[ec2-user@ip-17x-xx-x-xxx persistent]$ ls -lah\ntotal 64K\ndrwxr-xr-x 14 root           root  4.0K Oct  5 23:11 .\ndr-xr-xr-x 19 root           root  275 Dec 15  2019 ..\ndrwxr-xr-x  8       999  999   4096 Oct 13 20:07 db\ndrwxr-xr-x 13 root           root  4.0K Oct  5 23:03 drupal8\ndrwxr-xr-x  5           8183  8183   4.0K Feb 23  2020 iiifcache\ndrwxr-xr-x  2 root           root  4.0K Feb 23  2020 iiifconfig\ndrwxr-xr-x  4 root           root  4.0K Oct  5 22:45 nginx_conf\ndrwxr-xr-x  3 root           root  4.0K Feb 26  2019 solrconfig\ndrwxr-xr-x  3           8983 8983  4.0K Feb 26  2019 solrcore\n```\n\nTo get to this point, create a git clone of archipelago deployment and then copy the content of the /persistent out of the repo folder into this structure. The original (or what is left) archipelago-deployment ends inside a drupal8 folder here.\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Copy and paste the following to create a local copy of this file:"),(0,o.kt)("p",{parentName:"li"},'??? info "docker-compose.yml"'),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},'**Be sure to replace youremail@gmail.com with your email address.\n\n```YAML\n version: \'3.5\'\n services:\n   web:\n     container_name: esmero-web\n     image: staticfloat/nginx-certbot\n     restart: always\n     environment:\n       CERTBOT_EMAIL: "youremail@gmail.com"\n     ports:\n       - "80:80"\n       - "443:443"\n     volumes:\n       - /persistent/nginx_conf/conf.d:/etc/nginx/user.conf.d:ro\n       - /persistent/nginx_conf/certbot_extra_domains:/etc/nginx/certbot/extra_domains:ro\n       - /persistent/drupal8:/var/www/html:cached\n     depends_on:\n       - solr\n       - php\n     tty: true\n     networks:\n       - host-net\n       - esmero-net\n   php:\n     container_name: esmero-php\n     restart: always\n     image: "esmero/php-7.3-fpm:latest"\n     tty: true\n     networks:\n       - host-net\n       - esmero-net\n     volumes:\n       - ${PWD}:/var/www/html:cached\n   solr:\n     container_name: esmero-solr\n     restart: always\n     image: "solr:7.5.0"\n     tty: true\n     ports:\n       - "8983:8983"\n     networks:\n       - host-net\n       - esmero-net\n     volumes:\n       - /persistent/solrcore:/opt/solr/server/solr/mycores:cached\n       - /persistent/solrconfig:/drupalconfig:cached\n     entrypoint:\n       - docker-entrypoint.sh\n       - solr-precreate\n       - drupal\n       - /drupalconfig\n   # see https://hub.docker.com/_/mysql/\n   db:\n     image: mysql:5.7\n     command: --max_allowed_packet=256M\n     container_name: esmero-db\n     restart: always\n     environment:\n       MYSQL_ROOT_PASSWORD: esmerodb\n     networks:\n       - host-net\n       - esmero-net\n     volumes:\n       - /persistent/db:/var/lib/mysql:cached\n   iiif:\n     container_name: esmero-cantaloupe\n     image: "esmero/cantaloupe-s3:4.1.6"\n     restart: always\n     ports:\n       - "8183:8182"\n     networks:\n       - host-net\n       - esmero-net\n     volumes:\n       - /persistent/iiifconfig:/etc/cantaloupe\n       - /persistent/iiifcache:/var/cache/cantaloupe\n networks:\n   host-net:\n     driver: bridge\n   esmero-net:\n     driver: bridge\n     internal: true\n```\n')),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("em",{parentName:"p"},"Note: This file shows how the folders in Step 1 are being used, and how SSL is being automatically deployed and renewed (without any human interaction other than starting the docker-compose and watching the logs)."))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Now copy and paste the following to create a local copy of this file:"),(0,o.kt)("p",{parentName:"li"},'??? info "ngnix.conf"\n**Be sure to replace all instances of yoursite.org with your own domain.'),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},'```Shell\n # goes into /persistent/nginx_conf/conf.d/nginx.conf\n upstream cantaloupe {\n  server  esmero-cantaloupe:8182;\n  }\n\n  server {\n    listen              443 ssl;\n    server_name         yoursite.org;\n    ssl_certificate     /etc/letsencrypt/live/yourstie.org/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/yoursite.org/privkey.pem;\n\n     client_max_body_size 512M; ## Match with PHP from FPM container\n\n    root /var/www/html/web; ## <-- Your only path reference.\n\n    fastcgi_send_timeout 120s;\n    fastcgi_read_timeout 120s;\n    fastcgi_pass_request_headers on;\n\n    fastcgi_buffers 16 16k;\n    fastcgi_buffer_size 32k;\n\n    # Cantaloupe proxypass\n    location /cantaloupe/ {\n       proxy_set_header X-Forwarded-Proto $scheme;\n       proxy_set_header X-Forwarded-Host $host;\n       proxy_set_header X-Forwarded-Port $server_port;\n       proxy_set_header X-Forwarded-Path /cantaloupe/;\n       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n       if ($request_uri ~* "/cantaloupe/(.*)") {\n         proxy_pass http://cantaloupe/$1;\n       }\n    }\n\n    location = /favicon.ico {\n        log_not_found off;\n        access_log off;\n    }\n\n    location = /robots.txt {\n        allow all;\n        log_not_found off;\n        access_log off;\n    }\n\n    # Very rarely should these ever be accessed outside of your lan\n    location ~* \\.(txt|log)$ {\n        deny all;\n    }\n\n    location ~ \\..*/.*\\.php$ {\n        return 403;\n    }\n\n    location ~ ^/sites/.*/private/ {\n        return 403;\n    }\n\n    # Allow "Well-Known URIs" as per RFC 5785\n    location ~* ^/.well-known/ {\n        allow all;\n    }\n\n    # Block access to "hidden" files and directories whose names begin with a\n    # period. This includes directories used by version control systems such\n    # as Subversion or Git to store control files.\n    location ~ (^|/)\\. {\n        return 403;\n    }\n\n    location / {\n        try_files $uri /index.php?$query_string; # For Drupal >= 7\n    }\n\n    location @rewrite {\n        rewrite ^/(.*)$ /index.php?q=$1;\n    }\n\n    # Don\'t allow direct access to PHP files in the vendor directory.\n    location ~ /vendor/.*\\.php$ {\n        deny all;\n        return 404;\n    }\n\n    # Allow Modules to be updated via UI (still we believe composer is the way)    \n    rewrite ^/core/authorize.php/core/authorize.php(.*)$ /core/authorize.php$1;\n\n    # In Drupal 8, we must also match new paths where the \'.php\' appears in\n    # the middle, such as update.php/selection. The rule we use is strict,\n    # and only allows this pattern with the update.php front controller.\n    # This allows legacy path aliases in the form of\n    # blog/index.php/legacy-path to continue to route to Drupal nodes. If\n    # you do not have any paths like that, then you might prefer to use a\n    # laxer rule, such as:\n    #   location ~ \\.php(/|$) {\n    # The laxer rule will continue to work if Drupal uses this new URL\n    # pattern with front controllers other than update.php in a future\n    # release.\n    location ~ \'\\.php$|^/update.php\' {\n        fastcgi_split_path_info ^(.+?\\.php)(|/.*)$;\n        include fastcgi_params;\n        # Block httpoxy attacks. See https://httpoxy.org/.\n        fastcgi_param HTTP_PROXY "";\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        fastcgi_param PATH_INFO $fastcgi_path_info;\n        fastcgi_param PHP_VALUE "upload_max_filesize=512M \\n post_max_size=512M";\n        proxy_read_timeout 900s;\n        fastcgi_intercept_errors on;\n        fastcgi_pass esmero-php:9000;\n    }\n\n     # Fighting with Styles? This little gem is amazing.\n    location ~ ^/sites/.*/files/styles/ { # For Drupal >= 7\n        try_files $uri @rewrite;\n    }\n\n    # Handle private files through Drupal.\n    location ~ ^/system/files/ { # For Drupal >= 7\n        try_files $uri /index.php?$query_string;\n    }\n}\n```\n'))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create the following folder:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-Shell"},"/persistent/nginx_conf/conf.d/\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Place the ngnix.conf file inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"/conf.d/")," folder.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create also this other folder:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-Shell"},"/persistent/nginx_conf/certbot_extra_domains/\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"/certbot_extra_domains/")," folder, create a text file named the same way as your domain (which can/or not contain additional subdomains but needs to exist)."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-Shell"},"cat  /persistent/nginx_conf/certbot_extra_domains/yoursite.org\n")),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-Shell"},"drwxr-xr-x 2 root root 4.0K Oct  5 22:46 .\ndrwxr-xr-x 4 root root 4.0K Oct  5 22:45 ..\n-rw-r--r-- 1 root root   48 Oct  5 22:46 yoursite.org\n")),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("em",{parentName:"p"},"Optionally, create additional subdomains if needed.")),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-Shell"},"cat  /persistent/nginx_conf/certbot_extra_domains/yoursite.org\nsubdomain.yoursite.org\nanothersub.yoursite.org\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Make sure you have edited the ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"ngnix.conf")," files you created to match your own information. Also make sure to also adjust the paths if you do not want the /persistent approach described in Step 1.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Run the following commands:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-Shell"},"docker -compose up -d\ndocker ps\n")),(0,o.kt)("p",{parentName:"li"},"You should see this:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-Shell"},'b5a04747ee06        staticfloat/nginx-certbot    "/bin/bash /scripts/\u2026"   8 days ago          Up 8 days           0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp   esmero-web\n84afae094b57        esmero/php-7.3-fpm:latest    "docker-php-entrypoi\u2026"   8 days ago          Up 8 days           9000/tcp                                   esmero-php\n13a9214acfd0        esmero/cantaloupe-s3:4.1.6   "sh -c \'java -Dcanta\u2026"   8 days ago          Up 8 days           0.0.0.0:8183->8182/tcp                     esmero-cantaloupe\n044dd5bc7245        mysql:5.7                    "docker-entrypoint.s\u2026"   8 days ago          Up 8 days           3306/tcp, 33060/tcp                        esmero-db\n31f4f0f45acc        solr:7.5.0                   "docker-entrypoint.s\u2026"   8 days ago          Up 8 days           0.0.0.0:8983->8983/tcp                     esmero-solr\n'))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"SSL has now been configured for your Archipelago instance."))),(0,o.kt)("h3",{id:"user-contributed-documentation"},"User contributed documentation:"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Adding SSL to Archipelago running docker")," by ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/senyzspalding"},"Zachary Spalding"),": ",(0,o.kt)("a",{parentName:"p",href:"https://youtu.be/rfH5TLzIRIQ"},"https://youtu.be/rfH5TLzIRIQ")),(0,o.kt)("hr",null),(0,o.kt)("p",null,"Thank you for reading! Please contact us on our ",(0,o.kt)("a",{parentName:"p",href:"https://groups.google.com/forum/#!forum/archipelago-commons"},"Archipelago Commons Google Group")," with any questions or feedback."),(0,o.kt)("p",null,"Return to the ",(0,o.kt)("a",{parentName:"p",href:"/archipelago-documentation-docusaurus/docs/"},"Archipelago Documentation main page"),"."))}d.isMDXComponent=!0}}]);