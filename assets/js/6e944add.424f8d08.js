"use strict";(self.webpackChunkarchipelago_documentation_docsaurus=self.webpackChunkarchipelago_documentation_docsaurus||[]).push([[6581],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>h});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function r(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,l=e.originalType,s=e.parentName,u=r(e,["components","mdxType","originalType","parentName"]),d=p(a),m=o,h=d["".concat(s,".").concat(m)]||d[m]||c[m]||l;return a?n.createElement(h,i(i({ref:t},u),{},{components:a})):n.createElement(h,i({ref:t},u))}));function h(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var l=a.length,i=new Array(l);i[0]=m;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r[d]="string"==typeof e?e:o,i[1]=r;for(var p=2;p<l;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},8090:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>c,frontMatter:()=>l,metadata:()=>r,toc:()=>p});var n=a(7462),o=(a(7294),a(3905));const l={title:"Archipelago-deployment-live",tags:["Archipelago-deployment-live"]},i="Archipelago Deployment Live",r={unversionedId:"archipelago-deployment-live-readme",id:"archipelago-deployment-live-readme",title:"Archipelago-deployment-live",description:"A Cloud / Local production ready Archipelago Deployment using Docker and soon Kubernetes.",source:"@site/docs/archipelago-deployment-live-readme.md",sourceDirName:".",slug:"/archipelago-deployment-live-readme",permalink:"/archipelago-documentation-docusaurus/docs/archipelago-deployment-live-readme",draft:!1,editUrl:"https://pr.new/github.com/WWU-MaxBronsema/archipelago-documentation-docusaurus/docs/archipelago-deployment-live-readme.md",tags:[{label:"Archipelago-deployment-live",permalink:"/archipelago-documentation-docusaurus/docs/tags/archipelago-deployment-live"}],version:"current",frontMatter:{title:"Archipelago-deployment-live",tags:["Archipelago-deployment-live"]},sidebar:"tutorialSidebar",previous:{title:"Moving from archipelago-deployment to archipelago-deployment-live",permalink:"/archipelago-documentation-docusaurus/docs/archipelago-deployment-live-moveToLive"},next:{title:"Updating containers in an Archipelago-deployment-live instance",permalink:"/archipelago-documentation-docusaurus/docs/archipelago-deployment-live-updatingContainers"}},s={},p=[{value:"What is this repo for?",id:"what-is-this-repo-for",level:2},{value:"What is this repo not for?",id:"what-is-this-repo-not-for",level:2},{value:"Requirements",id:"requirements",level:2},{value:"Minimal",id:"minimal",level:3},{value:"Recommend base line",id:"recommend-base-line",level:3},{value:"Good for all large repository",id:"good-for-all-large-repository",level:3},{value:"OS:",id:"os",level:3},{value:"Skills and the important human aspect",id:"skills-and-the-important-human-aspect",level:3},{value:"Deployment on Linux/X86/AMD system",id:"deployment-on-linuxx86amd-system",level:2},{value:"Step 1:",id:"step-1",level:3},{value:"Step 2:",id:"step-2",level:3},{value:"Step 3. Setup your enviromental variables for Docker/Services",id:"step-3-setup-your-enviromental-variables-for-dockerservices",level:3},{value:"Setup Enviromentals",id:"setup-enviromentals",level:4},{value:"Running a fully qualified domain you wish a valid/signed certificate for AMD/INTEL Architecture?",id:"running-a-fully-qualified-domain-you-wish-a-validsigned-certificate-for-amdintel-architecture",level:4},{value:"Running a fully qualified domain you wish a valid/signed certificate for ARM64/Apple M1 Architecture?",id:"running-a-fully-qualified-domain-you-wish-a-validsigned-certificate-for-arm64apple-m1-architecture",level:4},{value:"Optional (expert) extra domains (does not apply to ARM64/Apple M1 Architecture):",id:"optional-expert-extra-domains-does-not-apply-to-arm64apple-m1-architecture",level:5},{value:"OR Running self-signed? (optional and does not apply to ARM64/Apple M1 Architecture):",id:"or-running-self-signed-optional-and-does-not-apply-to-arm64apple-m1-architecture",level:4},{value:"Step 4. First Run",id:"step-4-first-run",level:3},{value:"First Permissions",id:"first-permissions",level:4},{value:"Actual first run",id:"actual-first-run",level:4},{value:"Step 5. Deploy Drupal 9",id:"step-5-deploy-drupal-9",level:3},{value:"Composer and Drupal",id:"composer-and-drupal",level:4},{value:"Step 6. Users and initial Content.",id:"step-6-users-and-initial-content",level:3},{value:"Step 7. Set your public IIIF server URL to your actual domain",id:"step-7-set-your-public-iiif-server-url-to-your-actual-domain",level:3},{value:"Deployment on ARM64/v8(Graviton, Apple M1) system:",id:"deployment-on-arm64v8graviton-apple-m1-system",level:2},{value:"How do I know my Architecture?",id:"how-do-i-know-my-architecture",level:3},{value:"Caring &amp; Coding + Fixing + Testing",id:"caring--coding--fixing--testing",level:2},{value:"Acknowledgments",id:"acknowledgments",level:2},{value:"License",id:"license",level:2}],u={toc:p},d="wrapper";function c(e){let{components:t,...a}=e;return(0,o.kt)(d,(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"archipelago-deployment-live"},"Archipelago Deployment Live"),(0,o.kt)("p",null,"A Cloud / Local production ready Archipelago Deployment using Docker and soon Kubernetes."),(0,o.kt)("h2",{id:"what-is-this-repo-for"},"What is this repo for?"),(0,o.kt)("p",null,"Running Archipelago Commons on a live public instance using SSL with Blob/Object Storage backend "),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Cloud-based deployment, e.g. AWS/Azure under Linux"),(0,o.kt)("li",{parentName:"ul"},"Self-managed servers running Linux"),(0,o.kt)("li",{parentName:"ul"},"x86/AMD86 or ARM64/v8 CPU architectures")),(0,o.kt)("h2",{id:"what-is-this-repo-not-for"},"What is this repo not for?"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Running your own local/development Archipelago. For that we suggest using ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/esmero/archipelago-deployment"},"https://github.com/esmero/archipelago-deployment"))),(0,o.kt)("h2",{id:"requirements"},"Requirements"),(0,o.kt)("h3",{id:"minimal"},"Minimal"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"4 Gbytes of RAM (e.g AWS EC2 t3.medium) 2 CPUs, Single SSD Drive of 100 Gbytes")),(0,o.kt)("h3",{id:"recommend-base-line"},"Recommend base line"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"8 Gbytes of RAM (AWS EC2 t3.medium)  2 CPUs, Single SSD Drive of 100 Gbytes, optional: one magnetic Drive of 500 Gbytes for Caches/Temp files/Backups.")),(0,o.kt)("h3",{id:"good-for-all-large-repository"},"Good for all large repository"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"16 Gbytes of RAM (AWS EC2 m6g.xlarge - Graviton)  4 CPUs, Single SSD Drive of 200 Gbytes, optional: one magnetic Drive of 1TB for Caches/Temp files/Backups.")),(0,o.kt)("h3",{id:"os"},"OS:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Ubuntu 20.04 /Amazon Linux 2/Debian 10.9 / AlmaLinux (Centos replacement) matching your CPU architecture (of course)"),(0,o.kt)("li",{parentName:"ul"},"Most recent ",(0,o.kt)("inlineCode",{parentName:"li"},"Docker")," running as a service and ",(0,o.kt)("inlineCode",{parentName:"li"},"docker-compose"))),(0,o.kt)("h3",{id:"skills-and-the-important-human-aspect"},"Skills and the important human aspect"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Basic Unix/Linux terminal skills and a root/sudo account"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Docker")," basics knowledge and how to manage packages in your System"),(0,o.kt)("li",{parentName:"ul"},"Knowledge of how to manage AWS/Azure or any other cloud-based provider for Computing Instances and S3 compatible Object Storage system and the associated permissions credentials to do so."),(0,o.kt)("li",{parentName:"ul"},"To be patient. Please read everything. Do not skip steps. Do not only copy and paste commands. Explanations give context and might help you troubleshoot issues.")),(0,o.kt)("p",null,"Basically this guide is meant for humans with basic to medium ",(0,o.kt)("inlineCode",{parentName:"p"},"DevOps")," background or humans with patience that are willing to troubleshoot, ask, and try again when that background is not (yet) enough. And we are here to help."),(0,o.kt)("h2",{id:"deployment-on-linuxx86amd-system"},"Deployment on Linux/X86/AMD system"),(0,o.kt)("h3",{id:"step-1"},"Step 1:"),(0,o.kt)("p",null,"Deploy your base system"),(0,o.kt)("p",null,"Make sure your Firewall/AWS Security group has these ports open for everyone to access"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"443 (NGINX SSL)"),(0,o.kt)("li",{parentName:"ul"},"80 (NGINX HTTP)\nAnd protected/modally open for your own development/testing/administration"),(0,o.kt)("li",{parentName:"ul"},"8183 (Cantaloupe)"),(0,o.kt)("li",{parentName:"ul"},"8983 (Solr)"),(0,o.kt)("li",{parentName:"ul"},"6400 (NLP64)"),(0,o.kt)("li",{parentName:"ul"},"9001 (Minio)"),(0,o.kt)("li",{parentName:"ul"},"22 (so you can ssh into your machine)")),(0,o.kt)("p",null,"Setup your system using your favorite package manager with "),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Docker"),(0,o.kt)("li",{parentName:"ul"},"git"),(0,o.kt)("li",{parentName:"ul"},"htop"),(0,o.kt)("li",{parentName:"ul"},"tree"),(0,o.kt)("li",{parentName:"ul"},"docker-compose")),(0,o.kt)("p",null,"e.g. for Amazon Linux 2 (x86/amd64) these steps are tested:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'sudo yum update -y\nsudo amazon-linux-extras install -y docker\nsudo service docker start\nsudo usermod -a -G docker ec2-user\nsudo chkconfig docker on\nsudo systemctl enable docker\nsudo yum install -y git htop tree\nsudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose\nsudo chmod +x /usr/local/bin/docker-compose\nsudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose\nsudo reboot\n')),(0,o.kt)("p",null,"Reboot is needed to allow Docker to take full control over your OS resources."),(0,o.kt)("h3",{id:"step-2"},"Step 2:"),(0,o.kt)("p",null,"In your location of choice clone this repo"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"git clone https://github.com/esmero/archipelago-deployment-live\ncd archipelago-deployment-live\ngit checkout 1.0.0\n")),(0,o.kt)("h3",{id:"step-3-setup-your-enviromental-variables-for-dockerservices"},"Step 3. Setup your enviromental variables for Docker/Services"),(0,o.kt)("h4",{id:"setup-enviromentals"},"Setup Enviromentals"),(0,o.kt)("p",null,"Setup your deployment enviromental variables by copying the template"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"cp deploy/ec2-docker/.env.template deploy/ec2-docker/.env\n")),(0,o.kt)("p",null,"and editing it"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"nano deploy/ec2-docker/.env\n")),(0,o.kt)("p",null,"The content of that file would be similar to this."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-env"},"ARCHIPELAGO_ROOT=/home/ec2-user/archipelago-deployment-live\nARCHIPELAGO_EMAIL=your@validemail.org\nARCHIPELAGO_DOMAIN=your.domain.org\nMINIO_ACCESS_KEY=THE_S3_AZURE_OR_LOCAL_MINIO_KEY\nMINIO_SECRET_KEY=THE_S3_AZURE_OR_LOCAL_MINIO_SECRET\nMYSQL_ROOT_PASSWORD=YOUR_MYSQL_PASSWORD_FOR_ARCHIPELAGO\nMINIO_BUCKET_MEDIA=THE_NAME_OF_YOUR_S3_BUCKET_FOR_PERSISTEN_STORAGE\nMINIO_FOLDER_PREFIX_MEDIA=media/\nMINIO_BUCKET_CACHE=THE_NAME_OF_YOUR_S3_BUCKET_FOR_IIIF_STORAGE\nMINIO_FOLDER_PREFIX_CACHE=iiifcache/\nREDIS_PASSWORD=YOUR_REDIS_PASSWORD\n")),(0,o.kt)("p",null,"What does each key mean?"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"ARCHIPELAGO_ROOT"),": the ",(0,o.kt)("strong",{parentName:"li"},"absolute path")," to your ",(0,o.kt)("inlineCode",{parentName:"li"},"archipelago-deployment-live")," git repo in your host machine."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"ARCHIPELAGO_EMAIL"),": a valid ",(0,o.kt)("strong",{parentName:"li"},"email"),", will be used to register your SSL Certificate via Certbot."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"ARCHIPELAGO_DOMAIN"),": a valid ",(0,o.kt)("strong",{parentName:"li"},"domain name")," for your repository. This domain will be also used to request your SSL Certificate via Certbot."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"MINIO_ACCESS_KEY"),": If you are running a Cloud Service backed S3/Azure Storage this needs to be generated there. The user/IAM owner of this ACCESS KEY needs to have access to read/write the bucket you will configure in this same ",(0,o.kt)("inlineCode",{parentName:"li"},".env"),". If running local ",(0,o.kt)("inlineCode",{parentName:"li"},"min.io")," whatever you set will be used."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"MINIO_SECRET_KEY"),": If you are running a Cloud Service backed S3/Azure Storage this needs to generated there. The user/IAM owner of the matching SECRET_KEY needs to have access to read/write the bucket you will configure in this same ",(0,o.kt)("inlineCode",{parentName:"li"},".env")," file. If running local ",(0,o.kt)("inlineCode",{parentName:"li"},"min.io")," whatever you set will be used."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"MYSQL_ROOT_PASSWORD"),": The MYSQL 8 or Mariadb 15 password. This password will be used later also during Drupal deployment via ",(0,o.kt)("inlineCode",{parentName:"li"},"drush")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"MINIO_BUCKET_MEDIA"),": The name of your Persistant Storage Bucket. If using mini.io local we recommend keeping it simple, e.g. ",(0,o.kt)("inlineCode",{parentName:"li"},"archipelago"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"MINIO_FOLDER_PREFIX_MEDIA"),": The ",(0,o.kt)("inlineCode",{parentName:"li"},"folder")," (a prefix really) where your DO Storage and File storage will go inside the ",(0,o.kt)("inlineCode",{parentName:"li"},"MINIO_BUCKET_MEDIA")," Bucket. ",(0,o.kt)("inlineCode",{parentName:"li"},"media/")," is a ",(0,o.kt)("em",{parentName:"li"},"fine")," name for this one and common in archipelago deployments. ",(0,o.kt)("strong",{parentName:"li"},"IMPORTANT:")," Always terminate these with a ",(0,o.kt)("inlineCode",{parentName:"li"},"/"),". "),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"MINIO_BUCKET_CACHE"),": The name of your IIIF Cache storage Bucket. May be the same as ",(0,o.kt)("inlineCode",{parentName:"li"},"MINIO_BUCKET_MEDIA"),". If different make sure your your ",(0,o.kt)("inlineCode",{parentName:"li"},"MINIO_ACCESS_KEY")," and/or IAM role ACL have permission to read write to this one too."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"MINIO_FOLDER_PREFIX_CACHE"),":  The ",(0,o.kt)("inlineCode",{parentName:"li"},"folder")," (a prefix really) where Cantaloupe will/can write its ",(0,o.kt)("inlineCode",{parentName:"li"},"iiif")," caches. ",(0,o.kt)("inlineCode",{parentName:"li"},"iiifcache/")," is a ",(0,o.kt)("em",{parentName:"li"},"lovely")," name we use a lot. ",(0,o.kt)("strong",{parentName:"li"},"IMPORTANT:")," Always terminate these with a ",(0,o.kt)("inlineCode",{parentName:"li"},"/"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"REDIS_PASSWORD"),": Password for your REDIS (Drupal Cache/Queue storage) if you decide to enable the Drupal REDIS module.")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"IMPORTANT NOTE"),": For AWS EC2. If you selected an ",(0,o.kt)("inlineCode",{parentName:"p"},"IAM role")," for your server when setting it up/deploying it, ",(0,o.kt)("inlineCode",{parentName:"p"},"min.io")," will use the AWS EC2-backed internal API to request access to your S3. This means the ROLE itself needs to have read/write access (ACL) to the given Bucket(s) and your key/secrets won't be able to override that. Please do not ignore this note. It will save you a LOT of frustration and coffee. You can also run an EC2 instace without a given IAM and in that case just the ACCESS_KEY/SECRET will matter."),(0,o.kt)("p",null,"Now that you know, you also know that these values ",(0,o.kt)("strong",{parentName:"p"},"should not be shared")," and this ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," file ",(0,o.kt)("strong",{parentName:"p"},"should not be committed/kept in version control"),". Please be careful."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose")," will read this ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," and start all services for you based on its content."),(0,o.kt)("p",null,"Once you have modified this you are ready for your first big decision. "),(0,o.kt)("h4",{id:"running-a-fully-qualified-domain-you-wish-a-validsigned-certificate-for-amdintel-architecture"},"Running a fully qualified domain you wish a valid/signed certificate for AMD/INTEL Architecture?"),(0,o.kt)("p",null,"This means you will use the ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose-aws-s3.yml"),". Do the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"cp deploy/ec2-docker/docker-compose-aws-s3.yml deploy/ec2-docker/docker-compose.yml\n")),(0,o.kt)("h4",{id:"running-a-fully-qualified-domain-you-wish-a-validsigned-certificate-for-arm64apple-m1-architecture"},"Running a fully qualified domain you wish a valid/signed certificate for ARM64/Apple M1 Architecture?"),(0,o.kt)("p",null,"This means you will use the ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose-aws-s3-arm64.yml"),". Do the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"cp deploy/ec2-docker/docker-compose-aws-s3-arm64.yml deploy/ec2-docker/docker-compose.yml\n")),(0,o.kt)("h5",{id:"optional-expert-extra-domains-does-not-apply-to-arm64apple-m1-architecture"},"Optional (expert) extra domains (does not apply to ARM64/Apple M1 Architecture):"),(0,o.kt)("p",null,"If you have more than a single domain you may create a text file inside\n",(0,o.kt)("inlineCode",{parentName:"p"},"config_storage/nginxconfig/certbot_extra_domains/your.domain.org")," and write for each subdomain there an entry/line."),(0,o.kt)("h4",{id:"or-running-self-signed-optional-and-does-not-apply-to-arm64apple-m1-architecture"},"OR Running self-signed? (optional and does not apply to ARM64/Apple M1 Architecture):"),(0,o.kt)("p",null,"Only if you are not running a fully qualified domain you wish a valid/signed. We ",(0,o.kt)("strong",{parentName:"p"},"really DO not")," recommend this route. IF you plan on using this deployment for local testing or running on non SSL please go for ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/esmero/archipelago-deployment"},"https://github.com/esmero/archipelago-deployment")," which delivers the same experience in less than 20 minutes deployment time."),(0,o.kt)("p",null,"Generate a self signed Cert"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout data_storage/selfcert/private/nginx.key -out data_storage/selfcert/certs/nginx.crt \nsudo openssl dhparam -out data_storage/selfcert/dhparam.pem 4096\ncp deploy/ec2-docker/docker-compose-selfsigned.yml deploy/ec2-docker/docker-compose.yml\n")),(0,o.kt)("p",null,"Note: Self signed docker-compose.yml file is setup to use min.io with local storage"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"    volumes:\n      - ${ARCHIPELAGO_ROOT}/data_storage/minio-data:/data:cached\n")),(0,o.kt)("p",null,"This folder will be created by min.io. If you are using a secondary Drive (e.g. magnetic) you can modify your ",(0,o.kt)("inlineCode",{parentName:"p"},"deploy/ec2-docker/docker-compose.yml")," to use a folder there, e.g."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"    volumes:\n      - /persistentinotherdrive/data_storage/minio-data:/data:cached\n")),(0,o.kt)("p",null,"Make sure your logged in user can read/write to it."),(0,o.kt)("p",null,"NOTE: If you want to use AWS S3 storage for the self signed version replace the minio Service yaml block with this ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/esmero/archipelago-deployment-live/blob/e90cf7701f1ae8e0a580a0901aaadb669baa21fd/deploy/ec2-docker/docker-compose-aws-s3.yml#L108-L125"},"Service Block")," in your new ",(0,o.kt)("inlineCode",{parentName:"p"},"deploy/ec2-docker/docker-compose.yml"),". You can mix and match services and even remove all ",(0,o.kt)("inlineCode",{parentName:"p"},":cached")," statements for ",(0,o.kt)("em",{parentName:"p"},"improved")," R/W volumen performance."),(0,o.kt)("h3",{id:"step-4-first-run"},"Step 4. First Run"),(0,o.kt)("h4",{id:"first-permissions"},"First Permissions"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"sudo chown 8183:8183 config_storage/iiifconfig/cantaloupe.properties\nsudo chown -R 8183:8183 data_storage/iiifcache\nsudo chown -R 8183:8183 data_storage/iiiftmp\nsudo chown -R 8983:8983 data_storage/solrcore\n")),(0,o.kt)("h4",{id:"actual-first-run"},"Actual first run"),(0,o.kt)("p",null,"Time to spin our docker containers for the first time. We will start all without going into background so log/error checking is easier, especially if you have selected a Valid/Signed Cert choice and also want to be sure S3 keys/access are working."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"cd deploy/ec2-docker\ndocker-compose up\n")),(0,o.kt)("p",null,"You will see a lot of things happening. Check for errors/problems/clear alerts and give all a minute or so to start.\nOk, let's assume your setup managed to request a valid signed SSL cert, you will see a nice message!"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'- Congratulations! Your certificate and chain have been saved at:XXXXX\n   Your certificate will expire on 20XX-XX-XX. To obtain a new or\n   tweaked version of this certificate in the future, simply run\n   certbot again. To non-interactively renew *all* of your\n   certificates, run "certbot renew"\n')),(0,o.kt)("p",null,"Archipelago will do that for you whenever it's about to expire so no need to deal with this manually, even when ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose")," restarts."),(0,o.kt)("p",null,"Now press CTRL+C. ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose")," will shutdown gracefully. Good!"),(0,o.kt)("h3",{id:"step-5-deploy-drupal-9"},"Step 5. Deploy Drupal 9"),(0,o.kt)("h4",{id:"composer-and-drupal"},"Composer and Drupal"),(0,o.kt)("p",null,"Copy the shipped default composer.default.json to composer.json and composer.default.lock to composer.lock (ONLY if you are installing from scratch):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"cp ../../drupal/composer.default.json ../../drupal/composer.json\ncp ../../drupal/composer.default.lock ../../drupal/composer.lock\n")),(0,o.kt)("p",null,"Start Docker again"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"docker-compose up -d\n")),(0,o.kt)("p",null,"Wait a few seconds and run:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'docker exec -ti esmero-php bash -c "chown -R www-data:www-data private"\ndocker exec -ti esmero-php bash -c "chown -R www-data:www-data web/sites"\ndocker exec -ti esmero-php bash -c "composer install"\n')),(0,o.kt)("p",null,"Composer install will take a little while and bring all your PHP libraries."),(0,o.kt)("p",null,"Once done, execute our setup script that will prepare your Drupal ",(0,o.kt)("inlineCode",{parentName:"p"},"settings.php")," and bring some of the ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," enviromental variables to the Drupal environment. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec -ti esmero-php bash -c 'scripts/archipelago/setup.sh'\n")),(0,o.kt)("p",null,"And now you can deploy Drupal! "),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"IMPORTANT:")," Make sure you replace in the following command inside ",(0,o.kt)("inlineCode",{parentName:"p"},"root:MYSQL_ROOT_PASSWORD")," the ",(0,o.kt)("inlineCode",{parentName:"p"},"MYSQL_ROOT_PASSWORD")," string with the ",(0,o.kt)("strong",{parentName:"p"},"value")," you used/assigned in your ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," file for ",(0,o.kt)("inlineCode",{parentName:"p"},"MYSQL_ROOT_PASSWORD"),". And replace ",(0,o.kt)("inlineCode",{parentName:"p"},"ADMIN_PASSWORD")," with a password that is safe and you won't forget! That passwords is for your Drupal super user (uid:0)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'docker exec -ti -u www-data esmero-php bash -c "cd web;../vendor/bin/drush -y si --verbose --existing-config --db-url=mysql://root:MYSQL_ROOT_PASSWORD@esmero-db/drupal --account-name=admin --account-pass=ADMIN_PASSWORD -r=/var/www/html/web --sites-subdir=default --notify=false;drush cr;chown -R www-data:www-data sites;"\n')),(0,o.kt)("h3",{id:"step-6-users-and-initial-content"},"Step 6. Users and initial Content."),(0,o.kt)("p",null,"After installation is done (may take a few) you can install initial users and assign them roles. Copy each line separately. A missing permission will not let you ingest the initial Metadata Displays and AMI set."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'docker exec -ti esmero-php bash -c \'drush ucrt demo --password="demo"; drush urol metadata_pro "demo"\'\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'docker exec -ti esmero-php bash -c \'drush ucrt jsonapi --password="jsonapi"; drush urol metadata_api "jsonapi"\'\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec -ti esmero-php bash -c 'drush urol administrator \"admin\"'\n")),(0,o.kt)("p",null,"Before ingesting the base content we need to make sure we can access your ",(0,o.kt)("inlineCode",{parentName:"p"},"JSON-API")," on for your new domain. That means we need to change internal urls (",(0,o.kt)("inlineCode",{parentName:"p"},"https://esmero-web"),") to the new valid SSL driven ones. This is easy:"),(0,o.kt)("p",null,"On your host machine (no need to ",(0,o.kt)("inlineCode",{parentName:"p"},"docker exec")," these ones), replace first in the following command ",(0,o.kt)("inlineCode",{parentName:"p"},"your.domain.org")," with the domain you setup in your ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," file. Go to (cd into) ",(0,o.kt)("strong",{parentName:"p"},"your base git clone folder")," (Important: ",(0,o.kt)("strong",{parentName:"p"},"YOUR BASE CLONE FOLDER"),") and then run"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"}," sed -i 's/http:\\/\\/esmero-web/https:\\/\\/your.domain.org/g' drupal/scripts/archipelago/deploy.sh\n sed -i 's/http:\\/\\/esmero-web/https:\\/\\/your.domain.org/g' drupal/scripts/archipelago/update_deployed.sh\n")),(0,o.kt)("p",null,"Now your ",(0,o.kt)("inlineCode",{parentName:"p"},"deploy.sh")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"update_deployed.sh")," are update and ready. Let's ingest some Twig Templates, an AMI Set, menus and a Blocks."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"docker exec -ti esmero-php bash -c 'scripts/archipelago/deploy.sh'\n")),(0,o.kt)("p",null,"NOTE: ",(0,o.kt)("inlineCode",{parentName:"p"},"update_deployed.sh")," is not needed when deploying for the first time and totally ",(0,o.kt)("strong",{parentName:"p"},"discouraged")," on a customized Archipelago.\nIf you make modifications to your ",(0,o.kt)("inlineCode",{parentName:"p"},"Twig templates"),", that command will replace the ones shipped by us with fresh copies overwriting all your modifications. Only run to restore larger errors or when needing to update non-customized ones with newer versions."),(0,o.kt)("h3",{id:"step-7-set-your-public-iiif-server-url-to-your-actual-domain"},"Step 7. Set your public IIIF server URL to your actual domain"),(0,o.kt)("p",null,"By default archipelago ships with a public facing and an internal facing IIIF Server URLs configured. These urls are used by a number of IIIF enabled viewers and need to be changed to reflect your new reality (a real Domain name and a proxied path!). These settings belong to the ",(0,o.kt)("inlineCode",{parentName:"p"},"strawberryfield/format_strawberryfield")," module. "),(0,o.kt)("p",null,"First check your current settings:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'docker exec -ti esmero-php bash -c "drush config-get format_strawberryfield.iiif_settings"\n')),(0,o.kt)("p",null,"You will see the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"pub_server_url: 'http://localhost:8183/iiif/2'\nint_server_url: 'http://esmero-cantaloupe:8182/iiif/2'\n")),(0,o.kt)("p",null,"Let's modify ",(0,o.kt)("inlineCode",{parentName:"p"},"pub_server_url"),". Replace in the following command ",(0,o.kt)("inlineCode",{parentName:"p"},"your.domain.org")," with the domain you defined in your ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," file.\nNOTE: We are passing the ",(0,o.kt)("inlineCode",{parentName:"p"},"-y")," flag to ",(0,o.kt)("inlineCode",{parentName:"p"},"drush"),' avoid that way having to answer "yes".'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'docker exec -ti esmero-php bash -c "drush -y config-set format_strawberryfield.iiif_settings pub_server_url https://your.domain.org/cantaloupe/iiif/2"\n')),(0,o.kt)("p",null,"Finally Done! Now you can log into your new Archipelago using ",(0,o.kt)("inlineCode",{parentName:"p"},"https")," and start exploring. Thank you for following this guide!"),(0,o.kt)("h2",{id:"deployment-on-arm64v8graviton-apple-m1-system"},"Deployment on ARM64/v8(Graviton, Apple M1) system:"),(0,o.kt)("p",null,"This applies to AWS ",(0,o.kt)("inlineCode",{parentName:"p"},"m6g")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"t3g")," Instances and is documented inline in this guide. Please open an ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/esmero/archipelago-deployment-live/issues"},"ISSUE")," in this repository if you run into any problems.\nPlease review ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/esmero/archipelago-deployment-live/blob/1.0.0/deploy/ec2-docker/docker-compose-aws-s3-arm64.yml"},"https://github.com/esmero/archipelago-deployment-live/blob/1.0.0/deploy/ec2-docker/docker-compose-aws-s3-arm64.yml")," for more info."),(0,o.kt)("h3",{id:"how-do-i-know-my-architecture"},"How do I know my Architecture?"),(0,o.kt)("p",null,"Run "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"uname -m \n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"For an ",(0,o.kt)("inlineCode",{parentName:"li"},"x86(64 bit)")," processor system output will be ",(0,o.kt)("inlineCode",{parentName:"li"},"x86_64")),(0,o.kt)("li",{parentName:"ul"},"For an ",(0,o.kt)("inlineCode",{parentName:"li"},"ARM(64 bit)")," processor system output will be ",(0,o.kt)("inlineCode",{parentName:"li"},"aarch64"))),(0,o.kt)("h2",{id:"caring--coding--fixing--testing"},"Caring & Coding + Fixing + Testing"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/DiegoPino"},"Diego Pino")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/alliomeria"},"Allison Lund")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/aksm"},"Albert Min")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/giancarlobi"},"Giancarlo Birello"))),(0,o.kt)("h2",{id:"acknowledgments"},"Acknowledgments"),(0,o.kt)("p",null,"This software is a ",(0,o.kt)("a",{parentName:"p",href:"https://metro.org"},"Metropolitan New York Library Council")," Open-Source initiative and part of the Archipelago Commons project."),(0,o.kt)("h2",{id:"license"},"License"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"http://www.gnu.org/licenses/gpl-3.0.txt"},"GPLv3")))}c.isMDXComponent=!0}}]);